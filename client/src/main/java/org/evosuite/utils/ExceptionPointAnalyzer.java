package org.evosuite.utils;

import org.apache.commons.math3.distribution.GeometricDistribution;
import org.evosuite.testcase.AbstractTestChromosome;

import java.util.List;

public class ExceptionPointAnalyzer {
    public static Integer samplePositionByExceptionPoint(AbstractTestChromosome<?> chromosome, List<Integer> positionsToSample) {
        Integer exceptionPosition = chromosome.getFirstExceptionPosition();
        if (exceptionPosition == null) {
            return Randomness.choice(positionsToSample);
        }
        int numStmtBeforeException = (int) positionsToSample.stream().filter(a -> a <= exceptionPosition).count();
        if (numStmtBeforeException == 0) {
            return Randomness.choice(positionsToSample);
        }
        double p = 1 - ((double) numStmtBeforeException / (positionsToSample.size() + 1));
        int sampled = new GeometricDistribution(p).sample();
        if (sampled >= positionsToSample.size()) {
            sampled = positionsToSample.size() - 1;
        }
        return positionsToSample.get(sampled);
    }
}
