package org.evosuite.coverage.reachability.calcutator;

import org.evosuite.setup.Call;
import org.evosuite.setup.callgraph.CallGraphEntry;

import java.util.List;
import java.util.stream.IntStream;

/**
 * Helper class that computes the context similarity of a call context with respect to a target call context.
 */
public class ContextSimilarityCalculator {
    /**
     * Computes the context similarity of an executed call context with respect to a given target call context.
     * Function: sim = ratioExecutedCalls - penaltyFactor * ratioExecutedCalls
     * ratioExecutedCalls = number of matches (equal calls)
     * penaltyFactor = number divergent calls
     * If the last calls matches, then sqrt(sim) is returned, otherwise sim
     *
     * @param executedContext The list of method calls actually called
     * @param targetContext   The list of method calls that should be called
     * @return a value between 0 and 1. The closer to 1, the more similar the two call context are.
     */
    public static double calculate(List<Call> executedContext, List<CallGraphEntry> targetContext) {
        int startIdx = getFirstExecutedCallIndex(executedContext, targetContext);
        if (startIdx == targetContext.size()) {
            return 0.0;
        }
        int remainingTargetNodes = targetContext.size() - startIdx;
        int minSize = Math.min(executedContext.size(), remainingTargetNodes);

        int numExecutedCalls = (int) IntStream.range(startIdx, minSize)
                .filter(i -> compareCalls(executedContext.get(i), targetContext.get(i)))
                .count();
        double ratioExecutedCalls = (double) numExecutedCalls / remainingTargetNodes;
        if (ratioExecutedCalls == 1.0) {
            return 1.0;
        }

        double penaltyFactor = (double) Math.abs(executedContext.size() - remainingTargetNodes) / Math.max(executedContext.size(), remainingTargetNodes);
        double contextSim = ratioExecutedCalls - penaltyFactor * ratioExecutedCalls;
        if (compareCalls(executedContext.get(executedContext.size() - 1), targetContext.get(targetContext.size() - 1))) {
            return Math.sqrt(contextSim);
        }
        return contextSim;
    }

    public static CallGraphEntry getLastExecutedCall(List<Call> executedContext, List<CallGraphEntry> targetContext) {
        int startIdx = getFirstExecutedCallIndex(executedContext, targetContext);
        if (startIdx == targetContext.size()) {
            return null;
        }
        int remainingTargetNodes = targetContext.size() - startIdx;
        int minSize = Math.min(executedContext.size(), remainingTargetNodes);

        CallGraphEntry lastExecuted = null;
        for (int i = 0; i < minSize; i++) {
            Call executedCall = executedContext.get(i);
            CallGraphEntry targetCall = targetContext.get(i);
            if (compareCalls(executedCall, targetCall)) {
                lastExecuted = targetCall;
            }
        }
        return lastExecuted;
    }

    public static Call getDivergentCall(List<Call> executedContext, List<CallGraphEntry> targetContext) {
        int minSize = Math.min(executedContext.size(), targetContext.size());
        for (int i = 0; i < minSize; i++) {
            Call executedCall = executedContext.get(i);
            CallGraphEntry targetCall = targetContext.get(i);
            if (!compareCalls(executedCall, targetCall)) {
                return executedCall;
            }
        }
        return null;
    }

    private static int getFirstExecutedCallIndex(List<Call> executedContext, List<CallGraphEntry> targetContext) {
        int startIdx;
        for (startIdx = 0; startIdx < targetContext.size(); startIdx++) {
            if (compareCalls(executedContext.get(0), targetContext.get(startIdx))) {
                break;
            }
        }
        return startIdx;
    }

    private static boolean compareCalls(Call executedCall, CallGraphEntry targetCall) {
        if (executedCall.getMethodName().equals(targetCall.getMethodName())) {
            return executedCall.getClassName().equals(targetCall.getClassName()); // Perfect match
        } else {
            return false; // No match
        }
    }

}
