package org.evosuite.basic;

import com.examples.with.different.packagename.myapp.*;
import com.examples.with.different.packagename.myapp.VulnerableClassInternal;
import org.evosuite.EvoSuite;
import org.evosuite.Properties;
import org.evosuite.SystemTestBase;
import org.evosuite.ga.metaheuristics.GeneticAlgorithm;
import org.evosuite.strategy.TestGenerationStrategy;
import org.evosuite.testcase.execution.ExecutionTracer;
import org.evosuite.testsuite.TestSuiteChromosome;
import org.junit.Assert;
import org.junit.Test;

public class VulnerabilitySystemTest extends SystemTestBase {

    @Test
    public void testVulnerabilityFitnessInternal() {
        // Set-up global properties
        EvoSuite evosuite = new EvoSuite();
        String targetClass = MyCUTCallsInternal.class.getName();

        Properties.TARGET_CLASS = targetClass;
        Properties.INSTRUMENT_CONTEXT = true;
        Properties.INSTRUMENT_METHOD_CALLS = true;
        Properties.CRITERION = new Properties.Criterion[]{Properties.Criterion.VULNERABILITY};

        // CLI commands
        String[] command = new String[]{"-generateSuite", "-class", targetClass, "-DvulnClass=com.examples.with.different.packagename.myapp.VulnerableClassInternal", "-DvulnMethod=vulnerableMethod(Ljava/lang/String;)V", "-DvulnLine=23"};
        Object result = evosuite.parseCommandLine(command); // Summary of test generation

        // Get the executed GA instance and it best test suite
        GeneticAlgorithm<?> ga = getGAFromResult(result);
        TestSuiteChromosome best = (TestSuiteChromosome) ga.getBestIndividual();
        System.out.println("EvolvedTestSuite:\n" + best);
        Assert.assertEquals("Non-optimal coverage: ", 1d, best.getCoverage(), 0.001);
    }

    @Test
    public void testVulnerabilityFitnessDirectJAR() {
        // Set-up global properties
        EvoSuite evosuite = new EvoSuite();
        String targetClass = MyCUTCallsJARDirectly.class.getName();

        Properties.TARGET_CLASS = targetClass;
        Properties.INSTRUMENT_CONTEXT = true;
        Properties.INSTRUMENT_METHOD_CALLS = true;
        Properties.CRITERION = new Properties.Criterion[]{Properties.Criterion.VULNERABILITY};

        // CLI commands
        String[] command = new String[]{"-generateSuite", "-class", targetClass, "-DvulnClass", "org.example.VulnerableClassJAR", "-DvulnMethod", "vulnerableMethod(Ljava/lang/String;)V", "-DvulnLine", "23"};
        Object result = evosuite.parseCommandLine(command); // Summary of test generation

        // Get the executed GA instance and it best test suite
        GeneticAlgorithm<?> ga = getGAFromResult(result);
        TestSuiteChromosome best = (TestSuiteChromosome) ga.getBestIndividual();
        System.out.println("EvolvedTestSuite:\n" + best);
        Assert.assertEquals("Non-optimal coverage: ", 1d, best.getCoverage(), 0.001);
    }

    @Test
    public void testVulnerabilityFitnessIndirectJAR() {
        // Set-up global properties
        EvoSuite evosuite = new EvoSuite();
        String targetClass = MyCUTCallsJARIndirectly.class.getName();

        Properties.TARGET_CLASS = targetClass;
        Properties.INSTRUMENT_CONTEXT = true;
        Properties.INSTRUMENT_METHOD_CALLS = true;
        Properties.CRITERION = new Properties.Criterion[]{Properties.Criterion.VULNERABILITY};

        // CLI commands
        String[] command = new String[]{"-generateSuite", "-class", targetClass, "-DvulnClass", "org.example.VulnerableClassJAR", "-DvulnMethod", "vulnerableMethod(Ljava/lang/String;)V", "-DvulnLine", "23"};
        Object result = evosuite.parseCommandLine(command); // Summary of test generation

        // Get the executed GA instance and it best test suite
        GeneticAlgorithm<?> ga = getGAFromResult(result);
        TestSuiteChromosome best = (TestSuiteChromosome) ga.getBestIndividual();
        System.out.println("EvolvedTestSuite:\n" + best);
        Assert.assertEquals("Non-optimal coverage: ", 1d, best.getCoverage(), 0.001);
    }

    @Test
    public void testVulnerabilityFitnessDirectJARHierarchyV1() {
        // Set-up global properties
        EvoSuite evosuite = new EvoSuite();
        String targetClass = MyCUTCallsJARDirectlyHierarchyV1.class.getName();

        Properties.TARGET_CLASS = targetClass;
        Properties.INSTRUMENT_CONTEXT = true;
        Properties.INSTRUMENT_METHOD_CALLS = true;
        Properties.CRITERION = new Properties.Criterion[]{Properties.Criterion.VULNERABILITY};

        // CLI commands
        String[] command = new String[]{"-generateSuite", "-class", targetClass, "-DvulnClass", "org.example.hierarchy.VulnerableSuper", "-DvulnMethod", "vulnerableMethod(Ljava/lang/String;)V", "-DvulnLine", "23"};
        Object result = evosuite.parseCommandLine(command); // Summary of test generation

        // Get the executed GA instance and it best test suite
        GeneticAlgorithm<?> ga = getGAFromResult(result);
        TestSuiteChromosome best = (TestSuiteChromosome) ga.getBestIndividual();
        System.out.println("EvolvedTestSuite:\n" + best);
        Assert.assertEquals("Non-optimal coverage: ", 1d, best.getCoverage(), 0.001);
    }

    @Test
    public void testVulnerabilityFitnessDirectJARHierarchyV2() {
        // Set-up global properties
        EvoSuite evosuite = new EvoSuite();
        String targetClass = MyCUTCallsJARDirectlyHierarchyV2.class.getName();

        Properties.TARGET_CLASS = targetClass;
        Properties.INSTRUMENT_CONTEXT = true;
        Properties.INSTRUMENT_METHOD_CALLS = true;
        Properties.CRITERION = new Properties.Criterion[]{Properties.Criterion.VULNERABILITY};

        // CLI commands
        String[] command = new String[]{"-generateSuite", "-class", targetClass, "-DvulnClass", "org.example.hierarchy.VulnerableSuper", "-DvulnMethod", "vulnerableMethod(Ljava/lang/String;)V", "-DvulnLine", "23"};
        Object result = evosuite.parseCommandLine(command); // Summary of test generation

        // Get the executed GA instance and it best test suite
        GeneticAlgorithm<?> ga = getGAFromResult(result);
        TestSuiteChromosome best = (TestSuiteChromosome) ga.getBestIndividual();
        System.out.println("EvolvedTestSuite:\n" + best);
        Assert.assertEquals("Non-optimal coverage: ", 1d, best.getCoverage(), 0.001);
    }

    //TODO Spring tests
    /*
    //The Spring that I would like to have it working
    this("org.springframework.webflow.mvc.view.AbstractMvcView",
            "addEmptyValueMapping(Lorg/springframework/binding/mapping/impl/DefaultMapper;Ljava/lang/String;Ljava/lang/Object;)V",
            485);
    */
    /* A Spring alternative
    this("org.springframework.webflow.mvc.view.AbstractMvcView",
            "processUserEvent()V",
            213);
    */
    /* A Spring alternative that DO NOT works
    this("org.springframework.webflow.action.AbstractAction",
            "afterPropertiesSet()V",
            57);
    */
    /* A Spring alternative that works
    this("org.springframework.webflow.action.EventFactorySupport",
            "getYesEventId()Ljava/lang/String;",
            120);
    */
    /* A Spring alternative that works
    this("org.springframework.webflow.action.EventFactorySupport",
            "event(Ljava/lang/Object;Z)Lorg/springframework/webflow/execution/Event;",
            219);
    */

    /*
    @Test
    public void testVulnerabilityFitnessSpring() {
        // Set-up global properties
        EvoSuite evosuite = new EvoSuite();
        String targetClass = MyCUTSpring.class.getName();

        Properties.TARGET_CLASS = targetClass;
        Properties.INSTRUMENT_CONTEXT = true;
        Properties.INSTRUMENT_METHOD_CALLS = true;
        Properties.CRITERION = new Properties.Criterion[]{Properties.Criterion.VULNERABILITY};

        // CLI commands
        String[] command = new String[]{"-generateSuite", "-class", targetClass};
        Object result = evosuite.parseCommandLine(command); // Summary of test generation

        // Get the executed GA instance and it best test suite
        GeneticAlgorithm<?> ga = getGAFromResult(result);
        TestSuiteChromosome best = (TestSuiteChromosome) ga.getBestIndividual();
        System.out.println("EvolvedTestSuite:\n" + best);
        Assert.assertEquals("Non-optimal coverage: ", 1d, best.getCoverage(), 0.001);
    }
     */
}
