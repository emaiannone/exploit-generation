package org.evosuite.basic;

import com.examples.with.different.packagename.artificial.compress.CompressCallerFlexible;
import com.examples.with.different.packagename.artificial.compress.CompressCallerNo;
import com.examples.with.different.packagename.artificial.compress.CompressCallerYes;
import com.examples.with.different.packagename.artificial.jasypt.JasyptCallerFlexible;
import com.examples.with.different.packagename.artificial.jasypt.JasyptCallerYes;
import com.examples.with.different.packagename.artificial.jenkinscore.JenkinsCoreCallerFlexible;
import com.examples.with.different.packagename.artificial.jenkinsmailer.JenkinsMailerCallerHard;
import com.examples.with.different.packagename.artificial.jenkinsmultijob.JenkinsMultijobCallerFlexible;
import com.examples.with.different.packagename.artificial.nifi.NifiCallerFlexible;
import com.examples.with.different.packagename.artificial.nifi.NifiCallerNo;
import com.examples.with.different.packagename.artificial.nifi.NifiCallerYes;
import com.examples.with.different.packagename.artificial.primefaces.PrimefacesCallerHard;
import com.examples.with.different.packagename.artificial.tomcat.TomcatCallerFlexible;
import com.examples.with.different.packagename.artificial.tomcat.TomcatCallerNo;
import com.examples.with.different.packagename.artificial.tomcat.TomcatCallerYes;
import com.tikal.jenkins.plugins.multijob.MultiJobResumeBuild;
import hudson.ProxyConfiguration;
import hudson.tasks.Mailer;
import org.apache.catalina.core.StandardWrapper;
import org.apache.commons.compress.archivers.zip.X0017_StrongEncryptionHeader;
import org.apache.nifi.cluster.coordination.http.replication.okhttp.OkHttpReplicationClient;
import org.evosuite.EvoSuite;
import org.evosuite.Properties;
import org.evosuite.SystemTestBase;
import org.evosuite.ga.Chromosome;
import org.evosuite.ga.metaheuristics.GeneticAlgorithm;
import org.evosuite.result.TestGenerationResult;
import org.evosuite.testcase.TestChromosome;
import org.evosuite.testsuite.TestSuiteChromosome;
import org.jasypt.digest.StandardByteDigester;
import org.junit.Assert;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.junit.runners.Parameterized;
import org.primefaces.application.DialogNavigationHandler;
import org.slf4j.MarkerFactory;

import java.util.Arrays;
import java.util.Collection;
import java.util.List;
import java.util.stream.Collectors;

@RunWith(Parameterized.class)
public class VulnerabilityArtificialSystemTest extends SystemTestBase {

    private EvoSuite evosuite;
    //private static final String CP = "/home/emaia/IdeaProjects/exploit-generation/client/target/test-classes";
    private String targetClass;
    private String vulnerableClass;
    private String vulnerableMethod;
    private String vulnerableLine;
    private boolean shouldSucceed;

    /**
     * <p>
     * Provide the test input values for all test method in this class.
     * </p>
     *
     * @return a collection of object arrays, whose rows represent the test input values for each test case.
     */
    @Parameterized.Parameters
    public static Collection<Object[]> inputs() {
        return Arrays.asList(new Object[][]{
                // Some tests fail if done with others
                //{CompressCallerNo.class.getName(), X0017_StrongEncryptionHeader.class.getName(), "parseCentralDirectoryFormat([BII)V", "313", false},
                //{CompressCallerYes.class.getName(), X0017_StrongEncryptionHeader.class.getName(), "parseCentralDirectoryFormat([BII)V", "313", true},
                //{CompressCallerFlexible.class.getName(), X0017_StrongEncryptionHeader.class.getName(), "parseCentralDirectoryFormat([BII)V", "313", true},
                //{NifiCallerNo.class.getName(), OkHttpReplicationClient.class.getName(), "prepareRequest(Ljava/lang/String;Ljava/util/Map;Ljava/lang/Object;)Lorg/apache/nifi/cluster/coordination/http/replication/PreparedRequest;", "97", false},
                //{NifiCallerYes.class.getName(), OkHttpReplicationClient.class.getName(), "prepareRequest(Ljava/lang/String;Ljava/util/Map;Ljava/lang/Object;)Lorg/apache/nifi/cluster/coordination/http/replication/PreparedRequest;", "97", true},
                //{NifiCallerFlexible.class.getName(), OkHttpReplicationClient.class.getName(), "prepareRequest(Ljava/lang/String;Ljava/util/Map;Ljava/lang/Object;)Lorg/apache/nifi/cluster/coordination/http/replication/PreparedRequest;", "97", true},
                //{TomcatCallerNo.class.getName(), StandardWrapper.class.getName(), "servletSecurityAnnotationScan()V", "1139", false},
                //{TomcatCallerYes.class.getName(), StandardWrapper.class.getName(), "servletSecurityAnnotationScan()V", "1139", true},
                {TomcatCallerFlexible.class.getName(), StandardWrapper.class.getName(), "servletSecurityAnnotationScan()V", "1139", true},
                //{JasyptCallerNo.class.getName(), StandardByteDigester.class.getName(), "matches([B[B)Z", "1102", false},
                //{JasyptCallerYes.class.getName(), StandardByteDigester.class.getName(), "matches([B[B)Z", "1102", true},
                //{JasyptCallerFlexible.class.getName(), StandardByteDigester.class.getName(), "matches([B[B)Z", "1102", true},
                //{JenkinsCoreCallerNo.class.getName(), ProxyConfiguration.DescriptorImpl.class.getName(), "doValidateProxy(Ljava/lang/String;Ljava/lang/String;ILjava/lang/String;Ljava/lang/String;Ljava/lang/String;)Lhudson/util/FormValidation;", "344", false},
                //{JenkinsCoreCallerYes.class.getName(), ProxyConfiguration.DescriptorImpl.class.getName(), "doValidateProxy(Ljava/lang/String;Ljava/lang/String;ILjava/lang/String;Ljava/lang/String;Ljava/lang/String;)Lhudson/util/FormValidation;", "344", true},
                //{JenkinsCoreCallerFlexible.class.getName(), ProxyConfiguration.DescriptorImpl.class.getName(), "doValidateProxy(Ljava/lang/String;Ljava/lang/String;ILjava/lang/String;Ljava/lang/String;Ljava/lang/String;)Lhudson/util/FormValidation;", "344", true},
                //{JenkinsMultijobCallerNo.class.getName(), MultiJobResumeBuild.class.getName(), "getTarget()Ljava/lang/Object;", "78", false},
                //{JenkinsMultijobCallerYes.class.getName(), MultiJobResumeBuild.class.getName(), "getTarget()Ljava/lang/Object;", "78", true},
                //{JenkinsMultijobCallerFlexible.class.getName(), MultiJobResumeBuild.class.getName(), "getTarget()Ljava/lang/Object;", "78", true},
                //{JenkinsMailerCallerHard.class.getName(), Mailer.DescriptorImpl.class.getName(), "doSendTestMail(Ljava/lang/String;Ljava/lang/String;ZLjava/lang/String;Lhudson/util/Secret;ZLjava/lang/String;Ljava/lang/String;Ljava/lang/String;)Lhudson/util/FormValidation;", "566", false},
                //{PrimefacesCallerHard.class.getName(), DialogNavigationHandler.class.getName(), "handleNavigation(Ljavax/faces/context/FacesContext;Ljava/lang/String;Ljava/lang/String;)V", "86", false},
        });
    }

    public VulnerabilityArtificialSystemTest(String targetClass, String vulnerableClass, String vulnerableMethod, String vulnerableLine, boolean shouldSucceed) {
        this.targetClass = targetClass;
        this.vulnerableClass = vulnerableClass;
        this.vulnerableMethod = vulnerableMethod;
        this.vulnerableLine = vulnerableLine;
        this.shouldSucceed = shouldSucceed;
    }

    @Before
    public void setUp() {
        this.evosuite = new EvoSuite();
    }

    /**
     * <p>
     * Test the novel Vulnerability coverage criterion.
     * </p>
     * <p>
     * This test only works on client module classes only, so excluding all other useless classes.
     * </p>
     * <p>
     * This test, as required by the Vulnerability criterion, instruments the call context, meaning that it won't stop on the target class but traverse the statically called classes/methods.
     * </p>
     * <p>
     * The other inputs from this test come from the JUnit Parametric tests, that passes it:
     * <ul>
     *     <li><b>the target class</b> (a.k.a., CUT), the starting point for exploit generation, i.e., a class of a certain project;</li>
     *     <li><b>the vulnerable class</b>, the class affected by a certain target vulnerability;</li>
     *     <li><b>the vulnerable method</b>, the method affected by a certain target vulnerability;</li>
     *     <li><b>the vulnerable line</b>, the line affected by a certain target vulnerability;</li>
     * </ul>
     * </p>
     */
    @Test
    public void vulnerabilityCriterion() {
        Properties.CRITERION = new Properties.Criterion[]{Properties.Criterion.VULNERABILITY};
        Properties.TARGET_CLASS = targetClass;
        Properties.INSTRUMENT_CONTEXT = true;

        // This, plus -generateTests options disables WholeSuite (that required a fix in IndividualTestStrategy class, though)
        Properties.STRATEGY = Properties.Strategy.ONEBRANCH;
        // Minimization seems useless because we just need a single TC
        Properties.MINIMIZE = false;

        // TODO Why goal preparation is called multiple times? Maybe I should create all goals outside getCoverageGoal(), in an ad-hoc createGoals() called by the constructor

        // TODO Improve controllability: Useful: SEARCH_BUDGET, POPULATION and POPULATION_LIMIT, SECONDARY_OBJECTIVE
        // TODO disable ASSERTion generation

        String[] command = new String[]{"-generateTests",
                //"-projectCP", CP,
                "-class", targetClass,
                "-DvulnClass=" + vulnerableClass,
                "-DvulnMethod=" + vulnerableMethod,
                "-DvulnLine=" + vulnerableLine};
        Object result = evosuite.parseCommandLine(command);
        try {
            GeneticAlgorithm<?> ga = getGAFromResult(result);
            TestChromosome best = (TestChromosome) ga.getBestIndividual();
            System.out.println(String.format("### Best TC %d (Gen %d, Eval %d) ###", best.getTestCase().getID(), best.getAge(), best.getNumberOfEvaluations()));
            best.getTestCase().iterator().forEachRemaining(st -> System.out.println('\t' + st.getCode()));
            Assert.assertEquals("Non-optimal coverage: ", 1d, best.getCoverage(), 0.001);
        } catch (Throwable t) {
            t.printStackTrace(System.out);
            if (shouldSucceed) {
                Assert.fail();
            }
        }
    }
}
