package org.evosuite;

import com.opencsv.CSVReader;
import com.opencsv.CSVReaderBuilder;
import com.opencsv.exceptions.CsvValidationException;
import org.apache.commons.lang3.tuple.ImmutablePair;
import org.apache.commons.lang3.tuple.Pair;
import org.evosuite.coverage.vulnerability.VulnerabilityDescription;
import org.evosuite.utils.LoggingUtils;
import org.slf4j.Logger;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.FileReader;
import java.io.IOException;
import java.io.PrintWriter;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

public class SiegeIO {
    private static final Logger logger = LoggingUtils.getEvoLogger();

    public static final List<String> HEADERS = Arrays.asList(
            "cve",
            "status",
            "clientClass",
            "budget",
            "bestFitness",
            "iterations"
    );

    public static List<Pair<String, VulnerabilityDescription>> readAndParseCsv(String file) throws CsvValidationException, FileNotFoundException {
        List<Pair<String, VulnerabilityDescription>> vulnerabilityList = new ArrayList<>();
        try (CSVReader reader = new CSVReaderBuilder(new FileReader(file)).withSkipLines(1).build()) {
            String[] values;
            while ((values = reader.readNext()) != null) {
                vulnerabilityList.add(new ImmutablePair<>(values[0], new VulnerabilityDescription(values[2], values[3], Integer.parseInt(values[4]))));
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
        return vulnerabilityList;
    }

    public static void writeToCsv(String dir, String filename, List<List<String>> content) throws IOException {
        File exportDir = new File(dir);
        if (!exportDir.exists()) {
            exportDir.mkdir();
        }
        String fullFilename = Paths.get(dir, filename + ".csv").toString();
        File exportFile = new File(fullFilename);
        // If the file already exists, put the headers before
        if (!exportFile.exists()) {
            content.add(0, HEADERS);
        }
        try (PrintWriter csvWriter = new PrintWriter(new FileOutputStream(exportFile, true))) {
            for (List<String> line : content) {
                String csvLine = String.join(",", line);
                csvWriter.println(csvLine);
            }
        } catch (FileNotFoundException e) {
            throw new IOException("Could not write to " + fullFilename + ".");
        }
    }
}
